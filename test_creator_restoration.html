<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Host Restoration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .success-btn { background-color: #28a745; }
        .success-btn:hover { background-color: #1e7e34; }
        .danger-btn { background-color: #dc3545; }
        .danger-btn:hover { background-color: #c82333; }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .user-panel {
            display: inline-block;
            width: 45%;
            margin: 10px;
            vertical-align: top;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .creator { border-color: #28a745; }
        .joiner { border-color: #007bff; }
    </style>
</head>
<body>
    <h1>üß™ Creator Host Restoration Test</h1>
    <p>This test verifies that the original room creator automatically gets host privileges back when they rejoin.</p>

    <div class="test-section">
        <h2>Test Scenario</h2>
        <ol>
            <li><strong>Creator</strong> creates a room and becomes host</li>
            <li><strong>Joiner</strong> joins the room</li>
            <li><strong>Creator</strong> transfers host to Joiner (or leaves temporarily)</li>
            <li><strong>Creator</strong> refreshes/rejoins the room</li>
            <li><strong>Expected:</strong> Creator automatically becomes host again</li>
        </ol>
    </div>

    <div class="test-section">
        <div class="user-panel creator">
            <h3>üëë Room Creator</h3>
            <div id="creatorStatus" class="status info">Not connected</div>
            <div id="creatorInfo"></div>
            <button onclick="creatorConnect()">Connect as Creator</button>
            <button onclick="creatorCreateRoom()">Create Room</button>
            <button onclick="creatorRejoin()">Rejoin Room (Test Auto-Restore)</button>
            <button onclick="creatorTransferHost()">Transfer Host to Joiner</button>
        </div>

        <div class="user-panel joiner">
            <h3>üë§ Room Joiner</h3>
            <div id="joinerStatus" class="status info">Not connected</div>
            <div id="joinerInfo"></div>
            <button onclick="joinerConnect()">Connect as Joiner</button>
            <button onclick="joinerJoinRoom()">Join Room</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="testResults" class="status info">Run the test to see results</div>
    </div>

    <div class="test-section">
        <h2>Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script>
        let creatorWs = null;
        let joinerWs = null;
        let creatorUserId = null;
        let joinerUserId = null;
        let currentRoomId = null;
        let creatorHostId = null;
        let joinerHostId = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateCreatorStatus(message, type = 'info') {
            const statusDiv = document.getElementById('creatorStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateJoinerStatus(message, type = 'info') {
            const statusDiv = document.getElementById('joinerStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateCreatorInfo() {
            const infoDiv = document.getElementById('creatorInfo');
            infoDiv.innerHTML = `
                <strong>User ID:</strong> ${creatorUserId || 'N/A'}<br>
                <strong>Room ID:</strong> ${currentRoomId || 'N/A'}<br>
                <strong>Host ID:</strong> ${creatorHostId || 'N/A'}<br>
                <strong>Am I Host?:</strong> ${creatorUserId === creatorHostId ? '‚úÖ YES' : '‚ùå NO'}
            `;
        }

        function updateJoinerInfo() {
            const infoDiv = document.getElementById('joinerInfo');
            infoDiv.innerHTML = `
                <strong>User ID:</strong> ${joinerUserId || 'N/A'}<br>
                <strong>Room ID:</strong> ${currentRoomId || 'N/A'}<br>
                <strong>Host ID:</strong> ${joinerHostId || 'N/A'}<br>
                <strong>Am I Host?:</strong> ${joinerUserId === joinerHostId ? '‚úÖ YES' : '‚ùå NO'}
            `;
        }

        function updateTestResults() {
            const resultsDiv = document.getElementById('testResults');
            if (creatorUserId === creatorHostId && creatorUserId && creatorHostId) {
                resultsDiv.textContent = '‚úÖ SUCCESS: Creator has host privileges!';
                resultsDiv.className = 'status success';
            } else if (joinerUserId === joinerHostId && joinerUserId && joinerHostId) {
                resultsDiv.textContent = '‚ö†Ô∏è Joiner is currently host (expected during test)';
                resultsDiv.className = 'status warning';
            } else {
                resultsDiv.textContent = '‚ÑπÔ∏è Test in progress...';
                resultsDiv.className = 'status info';
            }
        }

        function creatorConnect() {
            if (creatorWs) creatorWs.close();
            
            creatorWs = new WebSocket('ws://localhost:5002/ws');
            
            creatorWs.onopen = () => {
                log('üëë Creator WebSocket connected');
                updateCreatorStatus('Connected', 'success');
                
                creatorWs.send(JSON.stringify({
                    type: 'register',
                    name: 'RoomCreator'
                }));
            };

            creatorWs.onclose = () => {
                log('üëë Creator WebSocket disconnected');
                updateCreatorStatus('Disconnected', 'error');
            };

            creatorWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`üëë Creator received: ${data.type} - ${JSON.stringify(data)}`);
                
                switch (data.type) {
                    case 'registered':
                        creatorUserId = data.user_id;
                        log(`üëë Creator registered as: ${creatorUserId}`);
                        updateCreatorInfo();
                        break;
                        
                    case 'room_created':
                        if (data.success) {
                            currentRoomId = data.room_id;
                            creatorHostId = creatorUserId; // Creator is host
                            log(`üëë Room created: ${currentRoomId} (Creator is host)`);
                            updateCreatorStatus(`Room created: ${currentRoomId}`, 'success');
                            updateCreatorInfo();
                            updateTestResults();
                        }
                        break;
                        
                    case 'room_joined':
                        if (data.success) {
                            currentRoomId = data.room_id;
                            if (data.host_id) {
                                creatorHostId = data.host_id;
                            }
                            log(`üëë Creator rejoined room: ${currentRoomId}, Host: ${creatorHostId}`);
                            updateCreatorInfo();
                            updateTestResults();
                        }
                        break;
                        
                    case 'host_transferred':
                        creatorHostId = data.new_host_id;
                        log(`üëë Creator sees host transfer: ${data.old_host_name} ‚Üí ${data.new_host_name} (${data.reason || 'manual'})`);
                        updateCreatorInfo();
                        updateTestResults();
                        
                        if (data.reason === 'original_creator_restoration') {
                            log('üéâ CREATOR HOST RESTORATION DETECTED!');
                            updateCreatorStatus('Host privileges restored!', 'success');
                        }
                        break;
                        
                    case 'transfer_host_result':
                        if (data.success) {
                            log(`üëë Creator successfully transferred host to ${data.new_host_name}`);
                        } else {
                            log(`üëë Creator failed to transfer host: ${data.message}`);
                        }
                        break;
                }
            };
        }

        function joinerConnect() {
            if (joinerWs) joinerWs.close();
            
            joinerWs = new WebSocket('ws://localhost:5002/ws');
            
            joinerWs.onopen = () => {
                log('üë§ Joiner WebSocket connected');
                updateJoinerStatus('Connected', 'success');
                
                joinerWs.send(JSON.stringify({
                    type: 'register',
                    name: 'RoomJoiner'
                }));
            };

            joinerWs.onclose = () => {
                log('üë§ Joiner WebSocket disconnected');
                updateJoinerStatus('Disconnected', 'error');
            };

            joinerWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`üë§ Joiner received: ${data.type} - ${JSON.stringify(data)}`);
                
                switch (data.type) {
                    case 'registered':
                        joinerUserId = data.user_id;
                        log(`üë§ Joiner registered as: ${joinerUserId}`);
                        updateJoinerInfo();
                        break;
                        
                    case 'room_joined':
                        if (data.success) {
                            if (data.host_id) {
                                joinerHostId = data.host_id;
                            }
                            log(`üë§ Joiner joined room: ${currentRoomId}, Host: ${joinerHostId}`);
                            updateJoinerInfo();
                            updateTestResults();
                        }
                        break;
                        
                    case 'host_transferred':
                        joinerHostId = data.new_host_id;
                        log(`üë§ Joiner sees host transfer: ${data.old_host_name} ‚Üí ${data.new_host_name} (${data.reason || 'manual'})`);
                        updateJoinerInfo();
                        updateTestResults();
                        break;
                }
            };
        }

        function creatorCreateRoom() {
            if (!creatorWs || creatorWs.readyState !== WebSocket.OPEN) {
                log('‚ùå Creator not connected');
                return;
            }
            
            log('üëë Creator creating room...');
            creatorWs.send(JSON.stringify({
                type: 'create_room',
                room_name: 'Test Room',
                max_users: 10
            }));
        }

        function joinerJoinRoom() {
            if (!joinerWs || joinerWs.readyState !== WebSocket.OPEN) {
                log('‚ùå Joiner not connected');
                return;
            }
            
            if (!currentRoomId) {
                log('‚ùå No room to join');
                return;
            }
            
            log(`üë§ Joiner joining room: ${currentRoomId}`);
            joinerWs.send(JSON.stringify({
                type: 'join_room',
                room_id: currentRoomId
            }));
        }

        function creatorTransferHost() {
            if (!creatorWs || creatorWs.readyState !== WebSocket.OPEN) {
                log('‚ùå Creator not connected');
                return;
            }
            
            if (!joinerUserId) {
                log('‚ùå Joiner not available for host transfer');
                return;
            }
            
            log(`üëë Creator transferring host to joiner: ${joinerUserId}`);
            creatorWs.send(JSON.stringify({
                type: 'transfer_host',
                target_user_id: joinerUserId
            }));
        }

        function creatorRejoin() {
            if (creatorWs) {
                creatorWs.close();
            }
            
            log('üëë Creator simulating rejoin (with host restoration)...');
            
            setTimeout(() => {
                creatorWs = new WebSocket('ws://localhost:5002/ws');
                
                creatorWs.onopen = () => {
                    log('üëë Creator reconnected for rejoin test');
                    
                    creatorWs.send(JSON.stringify({
                        type: 'register',
                        name: 'RoomCreator'
                    }));
                };

                creatorWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    log(`üëë Creator (rejoin) received: ${data.type} - ${JSON.stringify(data)}`);
                    
                    switch (data.type) {
                        case 'registered':
                            creatorUserId = data.user_id;
                            log(`üëë Creator re-registered as: ${creatorUserId}`);
                            
                            // Attempt to rejoin with was_host flag
                            setTimeout(() => {
                                log(`üëë Creator attempting to rejoin room: ${currentRoomId} (as original creator)`);
                                creatorWs.send(JSON.stringify({
                                    type: 'join_room',
                                    room_id: currentRoomId,
                                    was_host: true  // This should trigger automatic host restoration
                                }));
                            }, 500);
                            break;
                            
                        case 'room_joined':
                            if (data.success) {
                                if (data.host_id) {
                                    creatorHostId = data.host_id;
                                }
                                log(`üëë Creator rejoined! Host is now: ${creatorHostId}`);
                                updateCreatorInfo();
                                updateTestResults();
                                
                                if (creatorUserId === creatorHostId) {
                                    log('üéâ SUCCESS: Creator automatically became host again!');
                                    updateCreatorStatus('Host privileges restored!', 'success');
                                } else {
                                    log('‚ö†Ô∏è Creator rejoined but is not host yet...');
                                }
                            }
                            break;
                            
                        case 'host_transferred':
                            creatorHostId = data.new_host_id;
                            log(`üëë Creator sees host transfer: ${data.old_host_name} ‚Üí ${data.new_host_name} (${data.reason || 'manual'})`);
                            updateCreatorInfo();
                            updateTestResults();
                            
                            if (data.reason === 'original_creator_restoration') {
                                log('üéâ AUTOMATIC CREATOR RESTORATION SUCCESSFUL!');
                                updateCreatorStatus('Host privileges automatically restored!', 'success');
                            }
                            break;
                    }
                };
            }, 1000);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Initialize
        updateCreatorInfo();
        updateJoinerInfo();
        updateTestResults();
    </script>
</body>
</html>
